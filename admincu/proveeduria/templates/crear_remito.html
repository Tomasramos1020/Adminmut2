{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}Nuevo Remito (Salida de stock){% endblock %}
{% block header %}Nuevo Remito{% endblock %}

{% block contenido %}
<style>
  .contenido-interno{background:#fff;padding:20px;border-radius:8px;max-width:1400px;margin:auto}
  .form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
  .form-row .form-group{flex:1}
  label{display:block;font-weight:600;margin-bottom:6px}
  select,input[type="text"],input[type="date"],input[type="number"],textarea{
    width:100%;padding:8px;border:1px solid #ccc;border-radius:4px
  }
  .formset-linea{display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .formset-linea>*{flex:1}
  .eliminar{background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;flex:none}
  .btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer}
  .btn-guardar{background:#3498db;color:#fff}
  .btn-agregar{background:#2ecc71;color:#fff;margin-bottom:10px}
  .btn-cancelar{background:#95a5a6;color:#fff}
  input[type="checkbox"][name$="-DELETE"]{ display:none !important; }
  label[for$="-DELETE"]{ display:none !important; }
</style>

<div class="contenido-interno">
  <form method="post">
    {% csrf_token %}

    <div class="form-row">
      <div class="form-group">{{ form.fecha.label_tag }}{{ form.fecha }}</div>
      <div class="form-group">{{ form.deposito.label_tag }}{{ form.deposito }}</div>
    </div>

    <div class="form-row">
      <div class="form-group">{{ form.transporte.label_tag }}{{ form.transporte }}</div>
      <div class="form-group">{{ form.vendedor.label_tag }}{{ form.vendedor }}</div>
    </div>

    <div class="form-group">{{ form.socio.label_tag }}{{ form.socio }}</div>
    <div class="form-group">{{ form.sucursal.label_tag }}{{ form.sucursal }}</div>

    <div class="form-group">{{ form.observacion.label_tag }}{{ form.observacion }}</div>

    <hr>
    <h3>Ítems del Remito</h3>
    <div id="formset">
      {{ formset.management_form }}
      {% for f in formset %}
        <div class="formset-linea">
          {{ f.producto.label_tag }} {{ f.producto }}
          {{ f.cantidad.label_tag }} {{ f.cantidad }}
    
          <label for="">Precio</label>
          {{ f.precio }}  {# campo extra #}
    
          {{ f.detalle.label_tag }} {{ f.detalle }}
    
          <label>Total</label>
          <input type="text" class="form-control total-linea" value="" readonly>
    
          <button type="button" class="eliminar">Eliminar</button>
          {{ f.id }}
          {% if f.DELETE %}{{ f.DELETE }}{% endif %}
        </div>
      {% endfor %}
    </div>
    
    <div id="formset-empty" style="display:none;">
      <div class="formset-linea">
        {{ formset.empty_form.producto.label_tag }} {{ formset.empty_form.producto }}
        {{ formset.empty_form.cantidad.label_tag }} {{ formset.empty_form.cantidad }}
    
        <label for="">Precio</label>
        {{ formset.empty_form.precio }}
    
        {{ formset.empty_form.detalle.label_tag }}  {{ formset.empty_form.detalle }}
    
        <label>Total</label>
        <input type="text" class="form-control total-linea" value="" readonly>
    
        <button type="button" class="eliminar">Eliminar</button>
        {{ formset.empty_form.id }}
        {{ formset.empty_form.DELETE }}
      </div>
    </div>
    
    <div style="margin-top:10px; text-align:right; font-weight:600;">
      Total general: <span id="total-general">0.00</span>
    </div>
    

    <button type="button" id="agregar-linea" class="btn btn-agregar">Agregar línea</button>

    <div class="botones" style="margin-top:16px;display:flex;justify-content:space-between">
      <a href="{% url 'facturacion-proveeduria' %}" class="btn btn-cancelar">Cancelar</a>
      <button type="submit" class="btn btn-guardar">Guardar</button>
    </div>
  </form>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // -------- Utilidades --------
  function toNum(x){
    const v = parseFloat((x || "").toString().replace(",", "."));
    return isNaN(v) ? 0 : v;
  }

  function actualizarSucursales(socioId){
    $.get("{% url 'obtener_sucursales' %}", {socio_id: socioId}, function(data){
      const $sel = $("#id_sucursal");
      $sel.empty().append($("<option>").val("").text("---------"));
      data.sucursales.forEach(s => $sel.append($("<option>").val(s.id).text(s.nombre)));
    });
  }

  function recalcularLinea($linea){
    const qty    = toNum($linea.find(".cantidad-input").val());
    const precio = toNum($linea.find("input[name$='-precio']").val());
    const total  = qty * precio;
    $linea.find(".total-linea").val(total.toFixed(2));
  }

  function recalcularTotalGeneral(){
    let suma = 0;
    $("#formset .formset-linea:visible").each(function(){
      const v = toNum($(this).find(".total-linea").val());
      suma += v;
    });
    $("#total-general").text(suma.toFixed(2));
  }

  function wireLinea($linea){
    // Al cambiar el producto, traer precio_1 desde tu helper
    $linea.on("change", ".producto-select", function(){
      const pid = $(this).val();
      if(!pid){ return; }
      $.get("{% url 'obtener_precio_producto_remito' %}", {producto_id: pid}, function(data){
        const $precio = $linea.find("input[name$='-precio']");
        // Solo autocompletar si no hay precio cargado o es 0
        if($precio.val() === "" || toNum($precio.val()) === 0){
          $precio.val((data && typeof data.precio_1 !== "undefined") ? data.precio_1 : "");
          recalcularLinea($linea);
          recalcularTotalGeneral();
        }
      });
    });

    // Recalcular en vivo al cambiar cantidad o precio
    $linea.on("input", ".cantidad-input, input[name$='-precio']", function(){
      recalcularLinea($linea);
      recalcularTotalGeneral();
    });

    // Inicial
    recalcularLinea($linea);
  }

  $(function(){
    let totalForms = parseInt($('#id_form-TOTAL_FORMS').val() || '0', 10);

    // Wire inicial de líneas existentes
    $("#formset .formset-linea").each(function(){ wireLinea($(this)); });
    recalcularTotalGeneral();

    // Cambio de socio => actualizar sucursales
    $("#id_socio").on('change', function(){
      const v = $(this).val();
      if(v){ actualizarSucursales(v); }
    });

    // Eliminar línea
    $("#formset").on("click", ".eliminar", function(){
      const $linea = $(this).closest(".formset-linea");
      const $del = $linea.find('input[type="checkbox"][name$="-DELETE"]');

      if($del.length){
        // Formset estándar: marcar DELETE y ocultar
        $del.prop('checked', true);
        $linea.hide();
      }else{
        // Línea clonada del empty_form
        $linea.remove();
        totalForms--;
        $('#id_form-TOTAL_FORMS').val(totalForms);
      }
      recalcularTotalGeneral();
    });

    // Agregar línea nueva
    $("#agregar-linea").on('click', function(){
      const html = $("#formset-empty").html().replace(/__prefix__/g, totalForms);
      const $nuevo = $(html);
      $("#formset").append($nuevo);
      wireLinea($nuevo);
      totalForms++;
      $("#id_form-TOTAL_FORMS").val(totalForms);
      recalcularTotalGeneral();
    });
  });
</script>
{% endblock %}

