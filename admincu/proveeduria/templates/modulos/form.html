{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}{{ titulo }}{% endblock %}

{% block contenido %}
<style>
  .contenido-interno{
    background:#fff; padding:20px; border-radius:10px;
    max-width:1400px; width:95%; margin:auto;
  }

  .form-row{display:flex; gap:12px; flex-wrap:wrap; margin-bottom:14px}
  .form-group{flex:1; min-width:260px}
  label{display:block; font-weight:600; margin-bottom:6px}

  select, input[type="text"], input[type="number"], textarea{
    width:100%; padding:8px; border:1px solid #cfcfcf; border-radius:6px;
  }

  /* --- Tabla/Grilla de componentes --- */
  .formset-wrap{margin-top:8px}
  .formset-header,
  .formset-linea{
    display:grid;
    grid-template-columns: 2fr 0.7fr 0.9fr 0.9fr auto;
    gap:10px; align-items:center;
  }
  .formset-header{
    font-weight:700; color:#333; padding:8px 10px;
    background:#f2f4f7; border:1px solid #e6e8eb; border-radius:8px;
    font-size:13px;
  }
  .formset-linea{
    margin-top:8px; background:#fafafa;
    border:1px solid #e8e8e8; border-radius:8px;
    padding:8px 10px; font-size:13px;
  }

  .eliminar{
    background:#e74c3c; color:#fff; border:none;
    padding:8px 12px; border-radius:6px; cursor:pointer;
    white-space:nowrap; font-size:13px;
  }

  .btn{padding:10px 20px; border:none; border-radius:6px; cursor:pointer}
  .btn-guardar{background:#3498db; color:#fff}
  .btn-agregar{background:#2ecc71; color:#fff; margin:12px 0}
  .btn-cancelar{background:#95a5a6; color:#fff}

  /* ocultar checkbox DELETE nativo */
  input[type="checkbox"][name$="-DELETE"]{display:none !important}
  label[for$="-DELETE"]{display:none !important}

  .text-right{text-align:right}
  .totals-row{
    display:flex; justify-content:flex-end; margin-top:12px;
    font-weight:700; font-size:14px; color:#111;
  }
  .totals-box{
    background:#f8fafc; border:1px solid #e5e7eb;
    border-radius:8px; padding:10px 14px; min-width:260px;
    display:flex; justify-content:space-between;
  }
  .totals-label{color:#374151}
  .totals-value{color:#111}
  .text-danger.small{color:#e11d48 !important; font-size:12px}
</style>

<div class="contenido-interno">
  <form method="post">
    {% csrf_token %}

    {% if form.errors or form.non_field_errors or formset.non_form_errors %}
      <div class="alert alert-danger">
        {% if form.non_field_errors %}{{ form.non_field_errors }}{% endif %}
        {% if form.errors %}<div>Revisá los datos del formulario.</div>{% endif %}
        {% if formset.non_form_errors %}{{ formset.non_form_errors }}{% endif %}
      </div>
    {% endif %}

    <h4>{{ titulo }}</h4>

    <div class="form-row">
      <div class="form-group">
        {{ form.nombre.label_tag }}{{ form.nombre }}
      </div>
      <div class="form-group">
        {{ form.descripcion.label_tag }}{{ form.descripcion }}
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        {{ form.precio.label_tag }}{{ form.precio }}
      </div>
      <div class="form-group" style="display:flex; align-items:flex-end; gap:8px">
        <div style="width:100%">
          {{ form.activo.label_tag }}{{ form.activo }}
        </div>
      </div>
    </div>

    <hr>

    <h5>Componentes</h5>

    <div id="formset" class="formset-wrap" data-prefix="{{ formset.prefix }}">
      {{ formset.management_form }}

      <!-- Encabezado de columnas -->
      <div class="formset-header">
        <div>Componente</div>
        <div>Cantidad</div>
        <div class="text-right">Costo unitario</div>
        <div class="text-right">Subtotal</div>
        <div>Eliminar</div>
      </div>

      <!-- Filas existentes -->
      {% for f in formset.forms %}
        <div class="formset-linea">
          <div>
            {{ f.componente }}
            {% if f.componente.errors %}
              <div class="text-danger small">{{ f.componente.errors }}</div>
            {% endif %}
          </div>
          <div>
            {{ f.cantidad }}
            {% if f.cantidad.errors %}
              <div class="text-danger small">{{ f.cantidad.errors }}</div>
            {% endif %}
          </div>

          <!-- Costo unitario -->
          <div class="text-right">
            <span class="costo-unitario">$0.00</span>
          </div>

          <!-- Subtotal -->
          <div class="text-right">
            <span class="subtotal-linea">$0.00</span>
          </div>

          <div>
            <button type="button" class="eliminar">Eliminar</button>
            {{ f.id }}
            {% if f.DELETE %}{{ f.DELETE }}{% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Template para nuevas filas -->
    <template id="formset-empty">
      <div class="formset-linea">
        <div>
          {{ formset.empty_form.componente }}
        </div>
        <div>
          {{ formset.empty_form.cantidad }}
        </div>
        <div class="text-right">
          <span class="costo-unitario">$0.00</span>
        </div>
        <div class="text-right">
          <span class="subtotal-linea">$0.00</span>
        </div>
        <div>
          <button type="button" class="eliminar">Eliminar</button>
          {{ formset.empty_form.id }}
          {{ formset.empty_form.DELETE }}
        </div>
      </div>
    </template>

    <!-- total módulo -->
    <div class="totals-row">
      <div class="totals-box">
        <span class="totals-label">Costo total estimado del módulo:</span>
        <span class="totals-value" id="total-modulo">$0.00</span>
      </div>
    </div>

    <button type="button" id="agregar-linea" class="btn btn-agregar">Agregar línea</button>

    <div style="display:flex; justify-content:space-between; margin-top:16px">
      <a href="{% url 'modulos-index' %}" class="btn btn-cancelar">Cancelar</a>
      <button type="submit" class="btn btn-guardar">Guardar</button>
    </div>
  </form>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
  const $formset = $("#formset");
  const prefix = $formset.data("prefix");
  const $totalForms = $(`#id_${prefix}-TOTAL_FORMS`);
  let totalForms = parseInt($totalForms.val() || "0", 10);

  // ---------------- helpers ----------------

  function getCostMapFromSelect($select){
    const raw = $select.attr("data-cost-map") || "{}";
    try { return JSON.parse(raw); } catch(e){ return {}; }
  }

  function obtenerCostoUnitarioFila($linea){
    const $select = $linea.find("select.componente-select");
    const prodId = $select.val();
    const map = getCostMapFromSelect($select);
    const costo = map[prodId] || "0.00";
    return parseFloat(costo) || 0;
  }

  function obtenerCantidadFila($linea){
    const $inp = $linea.find("input.cantidad-input");
    const val = $inp.val();
    if(!val) return 0;
    return parseFloat(val) || 0;
  }

  function recalcularFila($linea){
    const cu = obtenerCostoUnitarioFila($linea);
    const cant = obtenerCantidadFila($linea);
    const subtotal = cu * cant;

    $linea.find(".costo-unitario").text("$" + cu.toFixed(2));
    $linea.find(".subtotal-linea").text("$" + subtotal.toFixed(2));
  }

  function recalcularTotalModulo(){
    let total = 0;
    $formset.find(".formset-linea:visible").each(function(){
        const $linea = $(this);
        const cu = obtenerCostoUnitarioFila($linea);
        const cant = obtenerCantidadFila($linea);
        total += cu * cant;
    });
    $("#total-modulo").text("$" + total.toFixed(2));
  }

  function recalcularFilaYTotal($linea){
    recalcularFila($linea);
    recalcularTotalModulo();
  }

  // --------------- eventos -----------------

  $formset.on("change", "select.componente-select", function(){
    const $linea = $(this).closest(".formset-linea");
    recalcularFilaYTotal($linea);
  });

  $formset.on("input", "input.cantidad-input", function(){
    const $linea = $(this).closest(".formset-linea");
    recalcularFilaYTotal($linea);
  });

  // eliminar fila
  $formset.on("click", ".eliminar", function(){
    const $linea = $(this).closest(".formset-linea");
    const $del = $linea.find("input[name$='-DELETE']");
    if ($del.length){
        $del.prop("checked", true);
        $linea.hide();
    } else {
        $linea.remove();
        totalForms--;
        $totalForms.val(totalForms);
    }
    recalcularTotalModulo();
  });

  // agregar nueva fila
  $("#agregar-linea").on("click", function(){
    const html = $("#formset-empty").html().replace(/__prefix__/g, totalForms);
    const $nuevo = $(html);
    $formset.append($nuevo);
    totalForms++;
    $totalForms.val(totalForms);

    // primer cálculo
    recalcularFilaYTotal($nuevo);
  });

  // init al cargar
  $formset.find(".formset-linea").each(function(){
    const $linea = $(this);
    // en caso de que Django no haya puesto las clases (por filas ya existentes en edición)
    $linea.find("select").addClass("componente-select");
    $linea.find("input[name$='-cantidad']").addClass("cantidad-input");

    recalcularFila($linea);
  });
  recalcularTotalModulo();
});
</script>
{% endblock %}








