{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}Nuevo Comprobante de Proveeduria{% endblock %}
{% block header %}Nuevo Comprobante de Proveeduria{% endblock %}

{% block contenido %}
<style>
    .contenido-interno {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 1200px;
        margin: auto;
    }
    .form-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    .form-row .form-group {
        flex: 1;
    }
    .form-group {
        margin-bottom: 15px;
    }
    label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }
    select, input[type="text"], input[type="date"], input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .formset-linea {
        display: flex;
        gap: 3px;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .formset-linea > * {
        flex: 1;
    }
    .form-total, .form-precio {
        background-color: #eee;
    }
    .eliminar {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        flex: none;
    }
    .botones {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-guardar {
        background-color: #3498db;
        color: white;
    }
    .btn-agregar {
        background-color: #2ecc71;
        color: white;
        margin-bottom: 10px;
    }
    .btn-cancelar {
        background-color: #95a5a6;
        color: white;
    }
</style>

<div class="contenido-interno">

    <form method="post">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group col-4">{{ form.punto_venta.label_tag }}{{ form.punto_venta }}</div>
            <div class="form-group col-4">{{ form.fecha.label_tag }}{{ form.fecha }}</div>
            <div class="form-group col-4">{{ form.deposito.label_tag }}{{ form.deposito }}</div>
        </div>
        
        <div class="form-row">
            <div class="form-group col-6">{{ form.transporte.label_tag }}{{ form.transporte }}</div>
            <div class="form-group col-6">{{ form.vendedor.label_tag }}{{ form.vendedor }}</div>
        </div>
        
        <div class="form-group">{{ form.socio.label_tag }}{{ form.socio }}</div>
        <div class="form-group">{{ form.sucursal.label_tag }}{{ form.sucursal }}</div>
        <hr>
        <h3>Productos</h3>
        <div id="formset">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-linea">
                    {{ form.producto.label_tag }} {{ form.producto }}
                    {{ form.precio.label_tag }} {{ form.precio }}
                    {{ form.costo.label_tag }} {{ form.costo }}
                    <label>Margen (%)</label>
                    <input type="number" class="form-margen" step="0.01" />
                    {{ form.cantidad.label_tag }} {{ form.cantidad }}
                    <label>Total</label>
                    <input type="number" class="form-total" readonly />
                    <button type="button" class="eliminar">Eliminar</button>
                </div>
            {% endfor %}
        </div>

        <div id="formset-empty" style="display:none;">
            <div class="formset-linea">
                {{ formset.empty_form.producto.label_tag }} {{ formset.empty_form.producto }}
                {{ formset.empty_form.precio.label_tag }} {{ formset.empty_form.precio }}
                {{ formset.empty_form.costo.label_tag }} {{ formset.empty_form.costo }}  {# ← ENLAZADO #}
                <label>Margen (%)</label>
                <input type="number" class="form-margen" step="0.01" />
                {{ formset.empty_form.cantidad.label_tag }} {{ formset.empty_form.cantidad }}
                <label>Total</label>
                <input type="number" class="form-total" readonly />
                <button type="button" class="eliminar">Eliminar</button>
            </div>
        </div>

        <button type="button" id="agregar-linea" class="btn btn-agregar">Agregar línea</button>

        <div class="form-group" style="text-align: right; font-size: 18px; font-weight: bold; margin-top: 15px;">
            <label for="total-final">Total Final:</label>
            <input type="number" id="total-final" readonly style="background: #eee; font-size: 18px; width: 200px; border: 1px solid #ccc; border-radius: 4px; padding: 6px; text-align: right;" />
        </div>

        <div class="botones">
            <a href="{% url 'facturacion-proveeduria' %}" class="btn btn-cancelar">Cancelar</a>
            <button type="submit" class="btn btn-guardar">Guardar</button>
        </div>
    </form>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function actualizarSucursales(socioId) {
        $.ajax({
            url: "{% url 'obtener_sucursales' %}",
            data: { socio_id: socioId },
            success: function (data) {
                const sucursalSelect = $("#id_sucursal");
                sucursalSelect.empty();
                sucursalSelect.append($("<option>").text("---------").attr("value", ""));
                data.sucursales.forEach(s => {
                    sucursalSelect.append($("<option>").text(s.nombre).attr("value", s.id));
                });
            }
        });
    }

    function calcularTotalFinal() {
        let totalFinal = 0;
        $('.form-total').each(function () {
            const val = parseFloat($(this).val()) || 0;
            totalFinal += val;
        });
        $('#total-final').val(totalFinal.toFixed(2));
    }

    function calcularTotal($linea) {
        const precio = parseFloat($linea.find('input[name$="-precio"]').val()) || 0;
        const cantidad = parseFloat($linea.find('input[name$="-cantidad"]').val()) || 0;
        const total = precio * cantidad;
        $linea.find('.form-total').val(total.toFixed(2));
        calcularTotalFinal();
    }

    // ← NUEVA: calcula el margen (%) a partir de precio y costo
    function calcularMargen($linea) {
        const costo  = parseFloat($linea.find('input[name$="-costo"]').val()) || 0;
        const precio = parseFloat($linea.find('input[name$="-precio"]').val()) || 0;
        if (costo > 0) {
            const margen = ((precio - costo) / costo) * 100;
            $linea.find('.form-margen').val(margen.toFixed(2));
        } else {
            $linea.find('.form-margen').val('');
        }
    }

    // ← NUEVA: actualiza precio cuando editás el margen
    function actualizarPrecioDesdeMargen($linea) {
        const costo  = parseFloat($linea.find('input[name$="-costo"]').val()) || 0;
        const margen = parseFloat($linea.find('.form-margen').val());
        if (costo > 0 && !isNaN(margen)) {
            const precio = costo * (1 + (margen / 100));
            $linea.find('input[name$="-precio"]').val(precio.toFixed(2));
            calcularTotal($linea);
            // No llamo calcularMargen para evitar loop; ya quedó consistente.
        }
    }

    function bindEventosLinea($linea) {
        const $precio   = $linea.find('input[name$="-precio"]');
        const $cantidad = $linea.find('input[name$="-cantidad"]');
        const $margen   = $linea.find('.form-margen');
        const $producto = $linea.find('select[name$="-producto"], input[name$="-producto"]');
      
        // Precio editable + recalcula total y margen
        $precio
          .removeAttr('readonly')
          .removeClass('form-precio')
          .css('background-color', '#eee')
          .on('input', function () {
            calcularTotal($linea);
            calcularMargen($linea);
          });
      
        // Cantidad
        $cantidad.on('input', function () {
          calcularTotal($linea);
        });
      
        // Margen -> actualiza precio
        $margen.on('input', function () {
          actualizarPrecioDesdeMargen($linea);
        });
      
        // Producto -> trae precio y costo
        $producto.on('change', function () {
            const productoId = $(this).val();
            if (productoId) {
            $.ajax({
                url: "{% url 'obtener_precio_producto' %}",
                data: { producto_id: productoId },
                success: function (data) {
                const precio = parseFloat(data.precio_1) || 0;
                const costo  = parseFloat(data.costo) || 0;
                const $costo = $linea.find('input[name$="-costo"]');
                $costo.val(costo.toFixed(2));
                $precio.val(precio.toFixed(2));
                calcularTotal($linea);
                calcularMargen($linea);
                }
            });
            } else {
            $linea.find('input[name$="-costo"]').val('');
            $precio.val('');
            $margen.val('');
            $linea.find('.form-total').val('0.00');
            calcularTotalFinal();
            }
        });
    }

    $(document).ready(function () {
        let totalForms = parseInt($('#id_form-TOTAL_FORMS').val());

        $("#id_socio").change(function () {
            const socioId = $(this).val();
            if (socioId) {
                actualizarSucursales(socioId);
            }
        });

        // Ligar eventos a líneas existentes
        $("#formset .formset-linea").each(function () {
            bindEventosLinea($(this));
            calcularTotal($(this)); // por si hay datos precargados
            calcularMargen($(this));
        });

        // Eliminar línea
        $("#formset").on("click", ".eliminar", function () {
            $(this).closest(".formset-linea").remove();
            calcularTotalFinal();
            totalForms--;
            $('#id_form-TOTAL_FORMS').val(totalForms);
        });
        
        // Agregar línea
        $("#agregar-linea").click(function () {
            const html = $("#formset-empty").html().replace(/__prefix__/g, totalForms);  // <- importante __prefix__
            $("#formset").append(html);
            bindEventosLinea($("#formset .formset-linea").last());
            totalForms++;
            $("#id_form-TOTAL_FORMS").val(totalForms);            
        });

        calcularTotalFinal();  // inicial
    });
        // --- estilos de error rápidos ---
        const cssErr = `
        .is-invalid{ border-color:#e74c3c !important; background:#fff6f6 !important; }
        .error-inline{ color:#e74c3c; font-size:12px; margin-top:2px; }
        `;
        $('<style>').text(cssErr).appendTo('head');

        // marca y mensaje en línea
        function marcarError($field, msg) {
        $field.addClass('is-invalid');
        // evitar duplicados
        if ($field.next('.error-inline').length === 0) {
            $field.after('<div class="error-inline">' + (msg || 'Revisá este campo') + '</div>');
        }
        }
        function limpiarErrores() {
        $('.is-invalid').removeClass('is-invalid');
        $('.error-inline').remove();
        $('#form-errors-box').remove();
        }
        function mostrarErrores(arr) {
        const unicos = [...new Set(arr)];
        const $box = $('<div id="form-errors-box" class="alert alert-danger" style="margin-bottom:12px;"></div>');
        $box.html('<ul style="margin:0; padding-left:18px;">' + unicos.map(e => '<li>'+e+'</li>').join('') + '</ul>');
        $('.contenido-interno form').prepend($box);
        $('html, body').animate({scrollTop: $box.offset().top - 20}, 200);
        }

        function setAttrsCantidad($linea){
        $linea.find('input[name$="-cantidad"]').attr({ required: true, min: '0.01', step: '0.01' });
        }

        // valida todas las líneas antes de enviar
        function validarAntesDeEnviar() {
        limpiarErrores();
        let ok = true;
        let errores = [];
        let lineasCargadas = 0;

        $('#formset .formset-linea').each(function(){
            const $linea = $(this);
            const $prod = $linea.find('select[name$="-producto"], input[name$="-producto"]');
            const $cant = $linea.find('input[name$="-cantidad"]');
            const $prec = $linea.find('input[name$="-precio"]');

            const vProd = ($prod.val() || '').toString().trim();
            const vCant = ($cant.val() || '').toString().trim();
            const vPrec = ($prec.val() || '').toString().trim();

            const tieneAlgo = vProd !== '' || vCant !== '' || vPrec !== '';

            if (!tieneAlgo) return; // línea vacía: la ignoramos

            lineasCargadas++;

            // producto obligatorio si la línea tiene algo
            if (vProd === '') {
            ok = false;
            marcarError($prod, 'Elegí un producto');
            errores.push('Seleccioná un producto en las líneas cargadas.');
            }

            // cantidad > 0 si la línea tiene algo
            const nCant = parseFloat(vCant.replace(',', '.'));
            if (isNaN(nCant) || nCant <= 0) {
            ok = false;
            marcarError($cant, 'Cantidad > 0');
            errores.push('La cantidad debe ser mayor a 0 en las líneas cargadas.');
            }
        });

        if (lineasCargadas === 0) {
            ok = false;
            errores.push('Cargá al menos un producto con cantidad.');
        }

        if (!ok) mostrarErrores(errores);
        return ok;
        }

        // aplicar attrs a las líneas existentes
        $("#formset .formset-linea").each(function(){ setAttrsCantidad($(this)); });

        // Hook al submit
        $('.contenido-interno form').on('submit', function(e){
        if (!validarAntesDeEnviar()) {
            e.preventDefault();
        }
        });

        // cuando agregás una línea nueva, también poné attrs a cantidad
        const _bindEventosLinea_original = bindEventosLinea;
        bindEventosLinea = function($linea){
        _bindEventosLinea_original($linea);
        setAttrsCantidad($linea);
        };


</script>
{% endblock %}