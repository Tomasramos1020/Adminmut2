{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}Nueva Compra de Productos{% endblock %}
{% block header %}Nueva Compra de Productos{% endblock %}

{% block contenido %}
<style>
    .contenido-interno {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 1200px;
        margin: auto;
    }
    .form-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    .form-row .form-group {
        flex: 1;
    }
    .form-group {
        margin-bottom: 15px;
    }
    label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }
    select, input[type="text"], input[type="date"], input[type="number"], textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .formset-linea {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .formset-linea > * {
        flex: 1;
    }
    .form-total, .form-precio {
        background-color: #eee;
    }
    .eliminar {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        flex: none;
    }
    .botones {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-guardar {
        background-color: #3498db;
        color: white;
    }
    .btn-agregar {
        background-color: #2ecc71;
        color: white;
        margin-bottom: 10px;
    }
    .btn-cancelar {
        background-color: #95a5a6;
        color: white;
    }
</style>

<div class="contenido-interno">
    <form method="post">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group col-4">{{ form.deposito.label_tag }}{{ form.deposito }}</div>
            <div class="form-group col-4">{{ form.numero.label_tag }}{{ form.numero }}</div>
            <div class="form-group col-4">{{ form.fecha.label_tag }}{{ form.fecha }}</div>
        </div>
        <div class="form-group">{{ form.acreedor.label_tag }}{{ form.acreedor }}</div>
        <div class="form-group">{{ form.observacion.label_tag }}{{ form.observacion }}</div>

        <hr>
        <h3>Productos</h3>
        <div id="formset">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-linea">
                    {{ form.producto.label_tag }} {{ form.producto }}
                    {{ form.precio.label_tag }} {{ form.precio }}
                    {{ form.cantidad.label_tag }} {{ form.cantidad }}
                    <label>Total</label>
                    <input type="number" class="form-total" readonly />
                    <button type="button" class="eliminar">Eliminar</button>
                </div>
            {% endfor %}
        </div>

        <div id="formset-empty" style="display:none;">
            <div class="formset-linea">
                {{ formset.empty_form.producto.label_tag }} {{ formset.empty_form.producto }}
                {{ formset.empty_form.precio.label_tag }} {{ formset.empty_form.precio }}
                {{ formset.empty_form.cantidad.label_tag }} {{ formset.empty_form.cantidad }}
                <label>Total</label>
                <input type="number" class="form-total" readonly />
                <button type="button" class="eliminar">Eliminar</button>
            </div>
        </div>

        <button type="button" id="agregar-linea" class="btn btn-agregar">Agregar l√≠nea</button>

        <div class="form-group" style="text-align: right; font-size: 18px; font-weight: bold; margin-top: 15px;">
            <label for="total-final">Total Final:</label>
            <input type="number" id="total-final" readonly style="background: #eee; font-size: 18px; width: 200px; border: 1px solid #ccc; border-radius: 4px; padding: 6px; text-align: right;" />
        </div>

        <div class="botones">
            <a href="{% url 'facturacion-proveeduria' %}" class="btn btn-cancelar">Cancelar</a>
            <button type="submit" class="btn btn-guardar">Guardar</button>
        </div>
    </form>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function calcularTotalFinal() {
        let totalFinal = 0;
        $('.form-total').each(function () {
            const val = parseFloat($(this).val()) || 0;
            totalFinal += val;
        });
        $('#total-final').val(totalFinal.toFixed(2));
    }

    function calcularTotal($linea) {
        const precio = parseFloat($linea.find('input[name$="-precio"]').val()) || 0;
        const cantidad = parseFloat($linea.find('input[name$="-cantidad"]').val()) || 0;
        const total = precio * cantidad;
        $linea.find('.form-total').val(total.toFixed(2));
        calcularTotalFinal();
    }

    function bindEventosLinea($linea) {
        $linea.find('input[name$="-cantidad"], input[name$="-precio"]').on('input', function () {
            calcularTotal($linea);
        });
    }

    $(document).ready(function () {
        let totalForms = parseInt($('#id_form-TOTAL_FORMS').val());

        $("#formset .formset-linea").each(function () {
            bindEventosLinea($(this));
            calcularTotal($(this));
        });

        $("#formset").on("click", ".eliminar", function () {
            $(this).closest(".formset-linea").remove();
            totalForms--;
            $('#id_form-TOTAL_FORMS').val(totalForms);
            calcularTotalFinal();
        });

        $("#agregar-linea").click(function () {
            const html = $("#formset-empty").html().replace(/__prefix__/g, totalForms);
            const $nuevaLinea = $('<div class="formset-linea"></div>').append(html);
            $("#formset").append($nuevaLinea);
            bindEventosLinea($nuevaLinea);
            totalForms++;
            $("#id_form-TOTAL_FORMS").val(totalForms);
        });

        calcularTotalFinal();
    });
</script>
{% endblock %}