{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}Nueva Compra de Productos{% endblock %}
{% block header %}Nueva Compra de Productos{% endblock %}

{% block contenido %}
<style>
    .contenido-interno {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 1200px;
        margin: auto;
    }
    .form-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    .form-row .form-group {
        flex: 1;
    }
    .form-group {
        margin-bottom: 15px;
    }
    label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }
    select, input[type="text"], input[type="date"], input[type="number"], textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .formset-linea {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .formset-linea > * {
        flex: 1;
    }
    .form-total, .form-precio {
        background-color: #eee;
    }
    .eliminar {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        flex: none;
    }
    .botones {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-guardar {
        background-color: #3498db;
        color: white;
    }
    .btn-agregar {
        background-color: #2ecc71;
        color: white;
        margin-bottom: 10px;
    }
    .btn-cancelar {
        background-color: #95a5a6;
        color: white;
    }
</style>

<div class="contenido-interno">
    <form method="post">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group col-2">{{ form.letra.label_tag }}{{ form.letra }}</div>
            <div class="form-group col-3">{{ form.punto_venta.label_tag }}{{ form.punto_venta }}</div>
            <div class="form-group col-3">{{ form.numero_cbte.label_tag }}{{ form.numero_cbte }}</div>
            <div class="form-group col-4">{{ form.fecha.label_tag }}{{ form.fecha }}</div>
          </div>
          <div class="form-row">
            <div class="form-group col-6">{{ form.deposito.label_tag }}{{ form.deposito }}</div>
            <div class="form-group col-6">{{ form.acreedor.label_tag }}{{ form.acreedor }}</div>
          </div>
          <div class="form-row">
            <div class="form-group col-6">
              {{ form.ajuste_distribuible.label_tag }}{{ form.ajuste_distribuible }}
              <small>Descuento negativo / Interés o percepción positivo.</small>
            </div>
          </div>
          {{ form.numero }} {# hidden; lo completa clean() #}

        <hr>
        <h3>Productos</h3>
        <div id="formset">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-linea">
                    {{ form.producto.label_tag }} {{ form.producto }}
                    {{ form.precio.label_tag }} {{ form.precio }}
                    <label>Precio ajustado</label>
                    <input type="number" class="form-precio-ajustado form-precio" readonly />
                    {{ form.cantidad.label_tag }} {{ form.cantidad }}
                    {% if es_ri %}
                    <label>Neto</label>
                    <input type="number" class="form-neto" readonly />
                
                    <label>IVA</label>
                    <input type="number" class="form-iva" readonly />
                
                    <label>Total</label>
                    <input type="number" class="form-total" readonly />
                {% else %}
                    <label>Total</label>
                    <input type="number" class="form-total" readonly />
                {% endif %}
                <button type="button" class="eliminar">Eliminar</button>
                </div>
            {% endfor %}
        </div>

        <div id="formset-empty" style="display:none;">
            <div class="formset-linea">
                {{ formset.empty_form.producto.label_tag }} {{ formset.empty_form.producto }}
                {{ formset.empty_form.precio.label_tag }} {{ formset.empty_form.precio }}
                <label>Precio ajustado</label>
                <input type="number" class="form-precio-ajustado form-precio" readonly />
                {{ formset.empty_form.cantidad.label_tag }} {{ formset.empty_form.cantidad }}
                {% if es_ri %}
                <label>Neto</label>
                <input type="number" class="form-neto" readonly />
                <label>IVA</label>
                <input type="number" class="form-iva" readonly />
                <label>Total</label>
                <input type="number" class="form-total" readonly />
            {% else %}
                <label>Total</label>
                <input type="number" class="form-total" readonly />
            {% endif %}
                <button type="button" class="eliminar">Eliminar</button>
            </div>
        </div>

        <button type="button" id="agregar-linea" class="btn btn-agregar">Agregar línea</button>
        {% if es_ri %}
        <div style="text-align:right; font-size:16px; margin-top:10px;">
            <div>
                <label>Total Neto:</label>
                <input type="number" id="total-neto-final" readonly style="width:200px;background:#eee;text-align:right;">
            </div>
            <div>
                <label>Total IVA:</label>
                <input type="number" id="total-iva-final" readonly style="width:200px;background:#eee;text-align:right;">
            </div>
        </div>
        {% endif %}

        <div class="form-group" style="text-align: right; font-size: 18px; font-weight: bold; margin-top: 15px;">
            <label for="total-final">Total Final:</label>
            <input type="number" id="total-final" readonly style="background: #eee; font-size: 18px; width: 200px; border: 1px solid #ccc; border-radius: 4px; padding: 6px; text-align: right;" />
        </div>


        <div class="botones">
            <a href="{% url 'facturacion-proveeduria' %}" class="btn btn-cancelar">Cancelar</a>
            <button type="submit" class="btn btn-guardar">Guardar</button>
        </div>
    </form>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const ES_RI = {{ es_ri|yesno:"true,false" }};
</script>
    
<script>
    function calcularTotalFinal() {
        recalcularTodo();
    }

    function calcularTotal($linea) {
        recalcularTodo();
    }

    function calcularTotalesRI() {
        recalcularTodo();
    }

    function getAjusteDistribuible() {
        const raw = ($('#id_ajuste_distribuible').val() || '').toString().trim();
        if (!raw) return 0;
        const val = parseFloat(raw.replace(',', '.'));
        return isNaN(val) ? 0 : val;
    }

    function parseNumero(raw) {
        const str = (raw || '').toString().trim();
        if (!str) return NaN;
        const val = parseFloat(str.replace(',', '.'));
        return isNaN(val) ? NaN : val;
    }

    function recalcularTodo() {
        const ajuste = getAjusteDistribuible();
        const lineas = [];

        $('#formset .formset-linea').each(function () {
            const $linea = $(this);
            const precio = parseNumero($linea.find('input[name$="-precio"]').val());
            const cantidad = parseNumero($linea.find('input[name$="-cantidad"]').val());
            const iva_pct = parseFloat($linea.data('iva') || 0);

            const precioValido = !isNaN(precio) && precio > 0;
            const cantidadValida = !isNaN(cantidad) && cantidad > 0;

            if (precioValido) {
                $linea.find('.form-precio-ajustado').val(precio.toFixed(2));
            } else {
                $linea.find('.form-precio-ajustado').val('');
            }

            if (precioValido && cantidadValida) {
                lineas.push({ $linea, precio, cantidad, iva_pct });
            } else {
                if (ES_RI) {
                    $linea.find('.form-neto').val('');
                    $linea.find('.form-iva').val('');
                }
                $linea.find('.form-total').val('');
            }
        });

        let totalBase = 0;
        lineas.forEach(l => { totalBase += (l.precio * l.cantidad); });

        const totalObjetivo = totalBase + ajuste;
        const usarAjuste = (ajuste !== 0 && totalBase > 0 && totalObjetivo > 0);
        const factor = usarAjuste ? (totalObjetivo / totalBase) : 1;

        let totalAplicado = 0;
        let totalNeto = 0;
        let totalIva = 0;
        let totalFinal = 0;

        lineas.forEach((l, idx) => {
            let precioAjustado = l.precio;
            if (usarAjuste) {
                if (idx < lineas.length - 1) {
                    precioAjustado = Math.round(l.precio * factor * 100) / 100;
                    totalAplicado += precioAjustado * l.cantidad;
                } else {
                    const objetivoLinea = totalObjetivo - totalAplicado;
                    precioAjustado = Math.round((objetivoLinea / l.cantidad) * 100) / 100;
                    totalAplicado += precioAjustado * l.cantidad;
                }
            }

            l.$linea.find('.form-precio-ajustado').val(precioAjustado.toFixed(2));

            if (!ES_RI) {
                const totalLinea = Math.round(precioAjustado * l.cantidad * 100) / 100;
                l.$linea.find('.form-total').val(totalLinea.toFixed(2));
                totalFinal += totalLinea;
                return;
            }

            const neto = Math.round(precioAjustado * l.cantidad * 100) / 100;
            const iva = Math.round(neto * (l.iva_pct / 100) * 100) / 100;
            const totalLinea = neto + iva;

            l.$linea.find('.form-neto').val(neto.toFixed(2));
            l.$linea.find('.form-iva').val(iva.toFixed(2));
            l.$linea.find('.form-total').val(totalLinea.toFixed(2));

            totalNeto += neto;
            totalIva += iva;
            totalFinal += totalLinea;
        });

        if (ES_RI) {
            $('#total-neto-final').val(totalNeto.toFixed(2));
            $('#total-iva-final').val(totalIva.toFixed(2));
        }
        $('#total-final').val(totalFinal.toFixed(2));
    }
    

    function bindEventosLinea($linea) {
        $linea.find('input[name$="-cantidad"], input[name$="-precio"]').on('input', function () {
            calcularTotal($linea);
        });
    }

    $(document).ready(function () {
        let totalForms = parseInt($('#id_form-TOTAL_FORMS').val());

        $("#formset .formset-linea").each(function () {
            const $linea = $(this);
            bindEventosLinea($linea);
        
            const productoID = $linea.find('select[name$="-producto"]').val();
        
            if (ES_RI && productoID) {
                // ✅ pedir IVA automáticamente al cargar
                $.get("{% url 'obtener_precio_producto' %}", { producto_id: productoID }, function(data){
                    const iva = parseFloat(data.iva || 0);
                    $linea.data('iva', iva);
                    calcularTotal($linea);
                });
            } else {
                calcularTotal($linea);
            }
        });
        ;

        $("#formset").on("click", ".eliminar", function () {
            $(this).closest(".formset-linea").remove();
            totalForms--;
            $('#id_form-TOTAL_FORMS').val(totalForms);
            if (ES_RI) {
                calcularTotalesRI();
            } else {
                calcularTotalFinal();
            }
        });

        $("#agregar-linea").click(function () {
            const html = $("#formset-empty").html().replace(/__prefix__/g, totalForms);
            const $nuevaLinea = $(html);
            $nuevaLinea.data('iva', null);

            const productoID = $nuevaLinea.find('select[name$="-producto"]').val();
            if (productoID) {
                $.get("{% url 'obtener_precio_producto' %}", { producto_id: productoID }, function(data){
                    $nuevaLinea.data('iva', parseFloat(data.iva || 0));
                    calcularTotal($nuevaLinea);
                });
            }
            

            $("#formset").append($nuevaLinea);
            bindEventosLinea($nuevaLinea);
            totalForms++;
            $("#id_form-TOTAL_FORMS").val(totalForms);
        });

        calcularTotalFinal();
    });
    $(document).on('input', '#id_ajuste_distribuible', function() {
        if (ES_RI) {
            calcularTotalesRI();
        } else {
            calcularTotalFinal();
        }
    });
    $(document).on('change', 'select[name$="-producto"]', function() {  
        const productoID = $(this).val();
        const $linea = $(this).parents('.formset-linea:first');
        if (!productoID) {
            $linea.data('iva', 0);
            calcularTotal($linea);
            return;
        }
    
        $.get("{% url 'obtener_precio_producto' %}", { producto_id: productoID }, function(data){
            const iva = parseFloat(data.iva || 0);
            $linea.data('iva', iva);
            calcularTotal($linea);
        });
    });
    
            // ====== Estilos y helpers de error ======
        const cssErr = `
        .is-invalid{ border-color:#e74c3c !important; background:#fff6f6 !important; }
        .error-inline{ color:#e74c3c; font-size:12px; margin-top:2px; }
        `;
        $('<style>').text(cssErr).appendTo('head');

        function marcarError($field, msg) {
        $field.addClass('is-invalid');
        if ($field.next('.error-inline').length === 0) {
        $field.after('<div class="error-inline">'+(msg||'Revisá este campo')+'</div>');
        }
        }
        function limpiarErrores() {
        $('.is-invalid').removeClass('is-invalid');
        $('.error-inline').remove();
        $('#form-errors-box').remove();
        }
        function mostrarErrores(arr) {
        const unicos = [...new Set(arr)];
        const $box = $('<div id="form-errors-box" class="alert alert-danger" style="margin-bottom:12px;"></div>');
        $box.html('<ul style="margin:0; padding-left:18px;">' + unicos.map(e => '<li>'+e+'</li>').join('') + '</ul>');
        $('.contenido-interno form').prepend($box);
        $('html, body').animate({scrollTop: $box.offset().top - 20}, 200);
        }

        // ====== Atributos requeridos en precio/cantidad ======
        function setAttrsLinea($linea){
        $linea.find('input[name$="-precio"]').attr({ required:true, min:'0.01', step:'0.01' });
        $linea.find('input[name$="-cantidad"]').attr({ required:true, min:'0.01', step:'0.01' });
        }

        // ====== Validación previa al submit ======
        function validarAntesDeEnviar() {
        limpiarErrores();
        let ok = true;
        let errores = [];
        let lineasCargadas = 0;

        $('#formset .formset-linea').each(function(){
        const $linea = $(this);
        const $prod = $linea.find('select[name$="-producto"], input[name$="-producto"]');
        const $prec = $linea.find('input[name$="-precio"]');
        const $cant = $linea.find('input[name$="-cantidad"]');

        const vProd = ($prod.val() || '').toString().trim();
        const vPrecStr = ($prec.val() || '').toString().trim();
        const vCantStr = ($cant.val() || '').toString().trim();

        // Consideramos "cargada" si hay algo en producto, precio o cantidad
        const tieneAlgo = vProd !== '' || vPrecStr !== '' || vCantStr !== '';
        if (!tieneAlgo) return;

        lineasCargadas++;

        // producto obligatorio
        if (vProd === '') {
            ok = false;
            marcarError($prod, 'Elegí un producto');
            errores.push('Seleccioná un producto en las líneas cargadas.');
        }

        // precio > 0
        const vPrec = parseFloat(vPrecStr.replace(',', '.'));
        if (isNaN(vPrec) || vPrec <= 0) {
            ok = false;
            marcarError($prec, 'Precio > 0');
            errores.push('El precio debe ser mayor a 0 en las líneas cargadas.');
        }

        // cantidad > 0
        const vCant = parseFloat(vCantStr.replace(',', '.'));
        if (isNaN(vCant) || vCant <= 0) {
            ok = false;
            marcarError($cant, 'Cantidad > 0');
            errores.push('La cantidad debe ser mayor a 0 en las líneas cargadas.');
        }
        });

        if (lineasCargadas === 0) {
        ok = false;
        errores.push('Cargá al menos un producto con precio y cantidad.');
        }

        if (!ok) mostrarErrores(errores);
        return ok;
        }

        // ====== Integración con tu JS existente ======

        // 1) Atributos requeridos en líneas ya renderizadas
        $("#formset .formset-linea").each(function(){ setAttrsLinea($(this)); });

        // 2) Hook al submit del formulario
        $('.contenido-interno form').on('submit', function(e){
        if (!validarAntesDeEnviar()) {
        e.preventDefault();
        }
        });

        // 3) Al agregar una línea nueva, también setear attrs y bindear eventos
        const _bindEventosLinea_original = (typeof bindEventosLinea === 'function') ? bindEventosLinea : function(){};
        bindEventosLinea = function($linea){
        _bindEventosLinea_original($linea);
        setAttrsLinea($linea);
        // limpiar marcas rojas al corregir
        $linea.find('input, select').on('input change', function(){
        $(this).removeClass('is-invalid');
        $(this).next('.error-inline').remove();
        });
        };

// 4) Cuando agregás la línea desde tu botón, ya llamás a bindEventosLinea($nuevaLinea)
//    y calcularTotal($nuevaLinea); no hace falta cambiar esa parte.

</script>
{% endblock %}
