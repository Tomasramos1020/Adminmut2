{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}Nueva Solicitud{% endblock %}
{% block header %}Nueva Solicitud{% endblock %}

{% block contenido %}
<style>
    .contenido-interno{
      background:#fff; padding:20px; border-radius:12px; max-width:1500px; margin:20px auto;
      box-shadow:0 6px 22px rgba(0,0,0,.08);
    }
    .form-row{display:flex; gap:12px; flex-wrap:wrap; margin-bottom:15px;}
    .form-row .form-group{flex:1; min-width:220px;}
    .form-group{margin-bottom:15px;}
    label{display:block; font-weight:600; margin-bottom:6px; color:#333;}
    select, input[type="text"], input[type="date"], input[type="number"]{
      width:100%; padding:8px 10px; border:1px solid #dcdcdc; border-radius:8px; background:#fff;
    }
  
    /* Contenedor de cada l√≠nea del formset */
    .formset-linea{
      display:grid;
      grid-template-columns: repeat(8, 1fr) 48px; /* 8 columnas iguales + 1 para el tachito */
      grid-auto-rows:auto;
      gap:12px; padding:16px;
      border:1px dashed #e6e6e6; border-radius:10px; background:#fafafa;
      align-items:start;
    }
  
    /* ===== Fila 1 (4 campos iguales): Establecimiento, Zona, GPS, Departamento ===== */
    .formset-linea .form-group:has(> [name$="establecimiento"]) { grid-column:1 / span 2; grid-row:1; }
    .formset-linea .info-establecimiento:has(.zona)             { grid-column:3 / span 2; grid-row:1; }
    .formset-linea .info-establecimiento:has(.gps)              { grid-column:5 / span 2; grid-row:1; }
    .formset-linea .info-establecimiento:has(.departamento)     { grid-column:7 / span 2; grid-row:1; }
  
    /* ===== Fila 2 (7 campos): Cultivo (x2), y seis campos de 1 columna ===== */
    .formset-linea .form-group:has(> [name$="cultivo"])         { grid-column:1 / span 2; grid-row:2; }
    .formset-linea .form-group:has(> [name$="hectarea"])        { grid-column:3 / span 1; grid-row:2; }
    .formset-linea .form-group:has(> [name$="participacion"])   { grid-column:4 / span 1; grid-row:2; }
    .formset-linea .form-group:has(> [name$="subsidio_max"])    { grid-column:5 / span 1; grid-row:2; }
    .formset-linea .form-group:has(> [name$="franquicia"])      { grid-column:6 / span 1; grid-row:2; }
    .formset-linea .form-group:has(> [name$="aporte_max"])      { grid-column:7 / span 1; grid-row:2; }
    .formset-linea .form-group:has(> [name$="aporte_total_qq"]) { grid-column:8 / span 1; grid-row:2; }
  
    /* Tachito, centrado verticalmente entre las 2 filas */
    .eliminar-wrapper{
      grid-column:9; grid-row:1 / span 2;
      justify-self:center; align-self:center;
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border:none; border-radius:10px; cursor:pointer;
      background:#ffe8e6; transition:transform .08s ease, background .15s ease;
    }
    .icon-btn:hover{ background:#ffd5d1; transform:translateY(-1px); }
    .icon-btn:active{ transform:translateY(0); }
    .icon-trash{ width:18px; height:18px; fill:#e74c3c; }
  
    /* Ocultar checkbox de borrado */
    input[name$="-DELETE"]{ display:none; }
  
    .botones{ margin-top:22px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .btn{ padding:10px 18px; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-imprimir{ background:#8e44ad; color:#fff; }
    .btn-cancelar{ background:#95a5a6; color:#fff; }
    .btn-guardar {
        background:#3498db; /* azul */
        color:#fff;
      }
      .btn-guardar:hover {
        background:#2980b9; /* azul m√°s oscuro al pasar el mouse */
      }
  
    .tabla{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px;
            border:1px solid #e7e7e7; border-radius:12px; overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.04); }
    .tabla thead th{ background:linear-gradient(180deg,#f8fafc,#f1f5f9); color:#334155; text-align:left; padding:10px 12px; font-weight:700; border-bottom:1px solid #e7e7e7; }
    .tabla tbody td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; }
    .tabla tbody tr:nth-child(odd){ background:#fcfcfc; }
    .tabla tfoot td{ padding:12px; background:#fafafa; font-weight:700; }
  
    /* Responsive: 1 columna + tachito */
    @media (max-width: 900px){
      .formset-linea{ grid-template-columns: 1fr 48px; }
      .formset-linea > *:not(.eliminar-wrapper){ grid-column:1 / 2 !important; }
      .eliminar-wrapper{ grid-column:2; grid-row:auto; align-self:start; }
    }
  </style>
  

<div class="contenido-interno">
    <form method="post">
        {% csrf_token %}

        <div class="form-row">
            <div class="form-group">{{ form.campa√±a.label_tag }}{{ form.campa√±a }}</div>
            <div class="form-group">{{ form.fecha.label_tag }}{{ form.fecha }}</div>
        </div>
        <div class="form-row">
            <div class="form-group">{{ form.suscripcion.label_tag }}{{ form.suscripcion }}</div>
            <div class="form-group">{{ form.socio.label_tag }}{{ form.socio }}</div>
        </div>

        <hr>
        <h3>L√≠neas de Solicitud</h3>

        {{ form.non_field_errors }}
        {{ formset.non_form_errors }}
        {% for f in formset %}{{ f.non_field_errors }}{% endfor %}
        
        <div id="formset">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-linea">
                    {{ form.id }}
                    <div class="form-group">
                        <label>Establecimiento</label>
                        <!-- ocultamos el select nativo para no romper el form -->
                        <div style="display:none;">
                          {{ form.establecimiento }}
                        </div>
                      
                        <!-- hidden controlado por JS (refleja el select oculto) -->
                        <input type="hidden" name="{{ form.establecimiento.name }}" value="{{ form.establecimiento.value|default:'' }}"/>
                      
                        <div style="display:flex; gap:8px; align-items:center;">
                          <span class="est-nombre" style="padding:6px 10px; background:#eef2ff; border-radius:8px; min-width:200px; display:inline-block;">
                            {% if form.instance and form.instance.establecimiento %}{{ form.instance.establecimiento.nombre }}{% else %}‚Äî Sin seleccionar ‚Äî{% endif %}
                          </span>
                          <button type="button" class="btn"
                                  style="background:#16a085;color:#fff;white-space:nowrap;"
                                  data-accion="elegir-est"
                                  title="Elegir o crear establecimiento">
                            Elegir / Crear
                          </button>
                        </div>
                      </div>
                    <div class="info-establecimiento">
                        <label>Departamento</label><div class="departamento"></div>
                    </div>
                    <div class="info-establecimiento">
                        <label>GPS</label><div class="gps"></div>
                    </div>
                    <div class="info-establecimiento">
                        <label>Zona</label><div class="zona"></div>
                    </div>

                    <div class="form-group">{{ form.cultivo.label_tag }}{{ form.cultivo }}</div>
                    <div class="form-group">{{ form.hectarea.label_tag }}{{ form.hectarea }}</div>
                    <div class="form-group">{{ form.participacion.label_tag }}{{ form.participacion }}</div>
                    <div class="form-group">{{ form.subsidio_max.label_tag }}{{ form.subsidio_max }}</div>
                    <div class="form-group">{{ form.franquicia.label_tag }}{{ form.franquicia }}</div>
                    <div class="form-group">{{ form.aporte_max.label_tag }}{{ form.aporte_max }}</div>
                    <div class="form-group">{{ form.aporte_total_qq.label_tag }}{{ form.aporte_total_qq }}</div>

                    {{ form.DELETE }}
                    <div class="eliminar-wrapper">
                        <!-- Tachito -->
                        <button type="button" class="icon-btn eliminar" title="Eliminar l√≠nea" aria-label="Eliminar l√≠nea">
                            <svg class="icon-trash" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1v12a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V7H4V5h4V4a1 1 0 0 1 1-1zm1 4H7v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V7h-3H10zm1 3h2v8h-2V10zm-4 0h2v8H7v-8zm8 0h2v8h-2v-8zM10 5v0h4V4h-4v1z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="formset-empty" style="display:none;">
            <div class="formset-linea">
                {{ formset.empty_form.id }}
                <div class="form-group">
                    <label>Establecimiento</label>
                    <div style="display:none;">
                      {{ formset.empty_form.establecimiento }}
                    </div>
                    <input type="hidden" name="{{ formset.empty_form.establecimiento.name }}" value=""/>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <span class="est-nombre" style="padding:6px 10px; background:#eef2ff; border-radius:8px; min-width:200px; display:inline-block;">
                        ‚Äî Sin seleccionar ‚Äî
                      </span>
                      <button type="button" class="btn"
                              style="background:#16a085;color:#fff;white-space:nowrap;"
                              data-accion="elegir-est"
                              title="Elegir o crear establecimiento">
                        Elegir / Crear
                      </button>
                    </div>
                  </div>
                  
                  
                <div class="info-establecimiento"><label>Departamento</label><div class="departamento"></div></div>
                <div class="info-establecimiento"><label>GPS</label><div class="gps"></div></div>
                <div class="info-establecimiento"><label>Zona</label><div class="zona"></div></div>
                <div class="form-group">{{ formset.empty_form.cultivo.label_tag }}{{ formset.empty_form.cultivo }}</div>
                <div class="form-group">{{ formset.empty_form.hectarea.label_tag }}{{ formset.empty_form.hectarea }}</div>
                <div class="form-group">{{ formset.empty_form.participacion.label_tag }}{{ formset.empty_form.participacion }}</div>
                <div class="form-group">{{ formset.empty_form.subsidio_max.label_tag }}{{ formset.empty_form.subsidio_max }}</div>
                <div class="form-group">{{ formset.empty_form.franquicia.label_tag }}{{ formset.empty_form.franquicia }}</div>
                <div class="form-group">{{ formset.empty_form.aporte_max.label_tag }}{{ formset.empty_form.aporte_max }}</div>
                <div class="form-group">{{ formset.empty_form.aporte_total_qq.label_tag }}{{ formset.empty_form.aporte_total_qq }}</div>
                {{ formset.empty_form.DELETE }}
                <div class="eliminar-wrapper">
                    <button type="button" class="icon-btn eliminar" title="Eliminar l√≠nea" aria-label="Eliminar l√≠nea">
                        <svg class="icon-trash" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1v12a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V7H4V5h4V4a1 1 0 0 1 1-1zm1 4H7v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V7h-3H10zm1 3h2v8h-2V10zm-4 0h2v8H7v-8zm8 0h2v8h-2v-8zM10 5v0h4V4h-4v1z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <button type="button" id="agregar-linea" class="btn" style="background:#2ecc71;color:#fff;margin-bottom:10px;">Agregar l√≠nea</button>
        <div id="modal-est" style="position:fixed; inset:0; display:none; z-index:9999;">
            <div style="position:absolute; inset:0; background:rgba(0,0,0,.35);"></div>
            <div id="modal-est-content" style="
                position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
                background:#fff; width:min(720px, 96vw); max-height:90vh; overflow:auto;
                border-radius:12px; box-shadow:0 18px 60px rgba(0,0,0,.2); padding:18px;">
              <!-- aqu√≠ se inyecta el form -->
            </div>
          </div>
          
        <hr>
        <h3>Resumen por Cultivo</h3>
        <div id="cuadro-resumen">
            <table class="tabla" id="tabla-resumen-cultivo">
                <thead>
                    <tr>
                        <th>Cultivo</th>
                        <th>Hect√°reas</th>
                        <th>Aporte en QQ</th>
                        <th>Valor Cereal</th>
                        <th>Garant√≠a</th>
                    </tr>
                </thead>
                <tbody id="resumen-body"></tbody>
            </table>
        </div>

        <h3>Resumen Final</h3>
        <table class="tabla" id="tabla-resumen-final">
            <thead>
                <tr>
                    <th>Hect√°reas reales</th>
                    <th>Suscripci√≥n por hect√°rea</th>
                    <th>Total Suscripci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="hectareas-reales">0,00</td>
                    <td id="valor-soja-final" data-valor-soja="0" data-soja-id="{{ soja_id|default:'' }}">$ 0,00</td>
                    <td id="total-soja">$ 0,00</td>
                </tr>
            </tbody>
        </table>

        <div class="botones">
            <a href="{% url 'fosea' %}" class="btn btn-cancelar">Cancelar</a>
            <button type="submit" class="btn btn-guardar">Guardar</button>
        </div>
    </form>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    /* ========= FORMATTERS ES-AR (miles y moneda) ========= */
    const fmtNum = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtARS = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });

    // --- FUNCIONES AUXILIARES ---
    function actualizarEstablecimientosPorSocio(socioId, $scope) {
        $.ajax({
            url: "{% url 'obtener_establecimientos' %}",
            data: { socio_id: socioId },
            success: function (data) {
                const $targets = $scope
                    ? $scope.find("select[name$='establecimiento']")
                    : $("select[name$='establecimiento']");
                $targets.each(function () {
                    const select = $(this);
                    const currentVal = select.val();
                    select.empty().append($("<option>").text("---------").attr("value", ""));
                    data.establecimientos.forEach(est => {
                        select.append($("<option>").text(est.nombre).attr("value", est.id));
                    });
                    if (currentVal && select.find(`option[value="${currentVal}"]`).length) {
                        select.val(currentVal);
                    }
                    select.prop("disabled", false).trigger('change');
                });
            }
        });
    }

    function cargarDatosEstablecimiento($select) {
        const estId = $select.val();
        const $linea = $select.closest(".formset-linea");
        if (estId) {
            $.ajax({
                url: "{% url 'datos_establecimiento' %}",
                data: { id: estId },
                success: function (data) {
                    $linea.find(".departamento").text(data.departamento || '');
                    $linea.find(".gps").text(data.gps || '');
                    $linea.find(".zona").text(data.zona || '');
                },
                error: function () {
                    $linea.find(".departamento, .gps, .zona").text("Error");
                }
            });
        } else {
            $linea.find(".departamento, .gps, .zona").text("");
        }
    }

    function cargarAportePorZonaYCultivo($linea) {
        const $selCult = $linea.find("select[name$='cultivo']");
        const $selEst  = $linea.find("select[name$='establecimiento']");
        const cultivoId = $selCult.val();
        const establecimientoId = $selEst.val() || $linea.find("input[name$='establecimiento']").val(); // fallback
      
        const $aporteInput = $linea.find("input[name$='aporte_max']");
        const $franquiciaInput = $linea.find("input[name$='franquicia']");
      
        if (cultivoId && establecimientoId) {
          $.ajax({
            url: "{% url 'aporte_por_zona_cultivo' %}",
            data: { cultivo_id: cultivoId, establecimiento_id: establecimientoId },
            success: function (data) {
              if (data.aporte !== null) $aporteInput.val(Number(data.aporte).toFixed(2));
              else $aporteInput.val('');
              if (data.franquicia !== null) $franquiciaInput.val(Number(data.franquicia).toFixed(2));
              else $franquiciaInput.val('');
              $aporteInput.prop('readonly', true);
              $franquiciaInput.prop('readonly', true);
            },
            error: function () {
              $aporteInput.val('').prop('readonly', true);
              $franquiciaInput.val('').prop('readonly', true);
            }
          });
        } else {
          $aporteInput.val('').prop('readonly', true);
          $franquiciaInput.val('').prop('readonly', true);
        }
      }
      

    function generarResumen() {
        const resumen = {};
        const cultivosIdMap = {};

        $("#formset .formset-linea").each(function () {
            const $linea = $(this);
            if ($linea.find("input[name$='-DELETE']").is(":checked") || !$linea.is(":visible")) return;

            // Evitar el empty_form
            const anyInput = $linea.find("input, select").first();
            if (anyInput.attr("name") && anyInput.attr("name").includes("__prefix__")) return;

            const cultivoSelect = $linea.find("select[name$='cultivo']");
            const cultivoId = cultivoSelect.val();
            const cultivoText = cultivoSelect.find(":selected").text().trim();
            const hectareaVal = parseFloat($linea.find("input[name$='hectarea']").val()) || 0;
            const aporteVal = parseFloat($linea.find("input[name$='aporte_total_qq']").val()) || 0;

            if (cultivoId) {
                if (!resumen[cultivoText]) {
                    resumen[cultivoText] = { hectareas: 0, aporte: 0 };
                    cultivosIdMap[cultivoText] = cultivoId;
                }
                resumen[cultivoText].hectareas += hectareaVal;
                resumen[cultivoText].aporte += aporteVal;
            }
        });

        const $body = $("#resumen-body").empty();

        for (const cultivo in resumen) {
            const cultivoId = cultivosIdMap[cultivo];
            const aporteTotal = resumen[cultivo].aporte;

            const $row = $(`
                <tr>
                    <td>${cultivo}</td>
                    <td class="hect">${fmtNum.format(resumen[cultivo].hectareas)}</td>
                    <td class="aporte">${fmtNum.format(aporteTotal)}</td>
                    <td class="valor-cereal" data-cultivo-id="${cultivoId}">Cargando‚Ä¶</td>
                    <td class="garantia">Calculando‚Ä¶</td>
                </tr>`);
            $body.append($row);

            $.ajax({
                url: "{% url 'cotizacion_por_cultivo' %}",
                data: { cultivo_id: cultivoId },
                success: function (data) {
                    const cotizacion = (data.cotizacion !== null) ? Number(data.cotizacion) : null;
                    const $valorCereal = $row.find(".valor-cereal");
                    const $garantia = $row.find(".garantia");

                    if (cotizacion !== null) {
                        $valorCereal.text(fmtARS.format(cotizacion));
                        const garantia = aporteTotal * cotizacion;
                        $garantia.text(fmtARS.format(garantia));
                    } else {
                        $valorCereal.text("No disponible");
                        $garantia.text("No disponible");
                    }
                },
                error: function () {
                    $row.find(".valor-cereal").text("Error");
                    $row.find(".garantia").text("Error");
                }
            });
        }
    }

    function actualizarSubsidioMaximo($linea) {
        const cultivoId = $linea.find("select[name$='cultivo']").val();
        const establecimientoId = $linea.find("select[name$='establecimiento']").val();
        const $subsidioInput = $linea.find("input[name$='subsidio_max']");
        if (cultivoId && establecimientoId) {
            $.ajax({
                url: "{% url 'obtener_subsidio_max' %}",
                data: { cultivo_id: cultivoId, establecimiento_id: establecimientoId },
                success: function (data) {
                    if (data.subsidio_maximo !== undefined) {
                        $subsidioInput.attr("max", data.subsidio_maximo);
                        $subsidioInput.attr("placeholder", `M√°ximo: ${data.subsidio_maximo}`);
                    } else {
                        $subsidioInput.removeAttr("max").attr("placeholder", "Subsidio m√°ximo");
                    }
                },
                error: function () {
                    $subsidioInput.removeAttr("max").attr("placeholder", "Error al cargar m√°ximo");
                }
            });
        } else {
            $subsidioInput.removeAttr("max").attr("placeholder", "Subsidio m√°ximo");
        }
    }

    function actualizarAporteTotal($linea) {
        const hectarea = parseFloat($linea.find("input[name$='hectarea']").val()) || 0;
        const subsidioMax = parseFloat($linea.find("input[name$='subsidio_max']").val()) || 0;
        const aporteMax = parseFloat($linea.find("input[name$='aporte_max']").val()) || 0;
        const aporteTotal = hectarea * subsidioMax * (aporteMax / 100);
        $linea.find("input[name$='aporte_total_qq']").val(aporteTotal.toFixed(2)); // input sin separadores
    }

    function calcularResumenFinal() {
        let hectareasReales = 0;
        const total = parseInt($("#id_form-TOTAL_FORMS").val(), 10) || 0;

        for (let i = 0; i < total; i++) {
            const $del  = $(`#id_form-${i}-DELETE`);
            const $hec  = $(`#id_form-${i}-hectarea`);
            const $part = $(`#id_form-${i}-participacion`);
            if (!$hec.length || !$part.length) continue;
            if ($del.length && $del.is(":checked")) continue;

            const h = parseFloat(String($hec.val() || "0").replace(',', '.')) || 0;
            const p = parseFloat(String($part.val() || "0").replace(',', '.')) || 0;
            hectareasReales += h * (p / 100);
        }

        $("#hectareas-reales").text(fmtNum.format(hectareasReales));

        const valorSuscripcion = parseFloat(String($("#id_suscripcion").val()).replace(',', '.')) || 0;
        const valorSojaCrudo   = parseFloat($("#valor-soja-final").data("valor-soja")) || 0;

        const valorSojaCalculado = (valorSojaCrudo / 100) * valorSuscripcion;
        const total$ = hectareasReales * valorSojaCalculado;

        $("#valor-soja-final").text(fmtARS.format(valorSojaCalculado));
        $("#total-soja").text(fmtARS.format(total$));
    }

    function recalcularTodo() {
        generarResumen();
        calcularResumenFinal();
    }

    // --- INICIALIZACI√ìN ---
    $(document).ready(function () {
        let totalForms = parseInt($('#id_form-TOTAL_FORMS').val(), 10) || 0;
        const socioSelect = $("#id_socio");

        function limpiarEstablecimientos() {
            $("select[name$='establecimiento']").each(function () {
                $(this).empty()
                    .append($("<option>").text("Selec. un socio primero").attr("value", ""))
                    .prop("disabled", true);
            });
        }

        const socioIdInicial = socioSelect.val();
        if (socioIdInicial) { actualizarEstablecimientosPorSocio(socioIdInicial); }
        else { limpiarEstablecimientos(); }

        if (totalForms === 0) { $('#agregar-linea').trigger('click'); }

        socioSelect.on('change', function () {
            const socioId = $(this).val();
            socioId ? actualizarEstablecimientosPorSocio(socioId) : limpiarEstablecimientos();
        });

        $("#formset").on("change", "select[name$='establecimiento']", function () {
            const $linea = $(this).closest(".formset-linea");
            cargarDatosEstablecimiento($(this));
            cargarAportePorZonaYCultivo($linea);
            actualizarSubsidioMaximo($linea);
        });

        $("#formset").on("change", "select[name$='cultivo']", function () {
            const $linea = $(this).closest(".formset-linea");
            cargarAportePorZonaYCultivo($linea);
            actualizarSubsidioMaximo($linea);
        });

        // Eliminar (tachito)
        $("#formset").on("click", ".eliminar", function () {
            const $fila = $(this).closest(".formset-linea");
            const $deleteInput = $fila.find("input[name$='-DELETE']");
            if ($deleteInput.length) {
                $deleteInput.prop("checked", true).trigger("change");
                $fila.hide();
            } else {
                $fila.remove();
            }
            recalcularTodo();
        });

        $("#agregar-linea").click(function () {
            const html = $("#formset-empty").html().replace(/__prefix__/g, totalForms);
            const $nuevaLinea = $(html);
            $("#formset").append($nuevaLinea);
            totalForms++;
            $("#id_form-TOTAL_FORMS").val(totalForms);

            recalcularTodo();

            const socioId = socioSelect.val();
            if (socioId) {
                actualizarEstablecimientosPorSocio(socioId, $nuevaLinea);
            } else {
                $nuevaLinea.find("select[name$='establecimiento']")
                    .empty().append($("<option>").text("Selec. un socio primero").attr("value", ""))
                    .prop("disabled", true);
            }
        });

        // Re-c√°lculos
        $("#formset").on("input", "input[name$='hectarea'], input[name$='aporte_max']", function () {
            const $linea = $(this).closest(".formset-linea");
            actualizarAporteTotal($linea);
            generarResumen();
        });
        $("#formset").on("change", "input, select", generarResumen);
        $("#formset").on("change", "input, select", calcularResumenFinal);
        $("#formset").on("input", "input[name$='hectarea'], input[name$='participacion']", calcularResumenFinal);
        $("#id_suscripcion").on("input", calcularResumenFinal);

        $("#formset").on("input", "input[name$='subsidio_max']", function () {
            const $linea = $(this).closest(".formset-linea");
            actualizarAporteTotal($linea);
            generarResumen();
        });

        // Valor soja para resumen final
        function obtenerValorSoja() {
            const sojaId = $("#valor-soja-final").data("soja-id");

            if (!sojaId) {
                $("#valor-soja-final").text("No disponible").data("valor-soja", 0);
                calcularResumenFinal();
                return;
              }
            
            $.ajax({
                url: "{% url 'cotizacion_por_cultivo' %}",
                data: { cultivo_id: sojaId},
                success: function (data) {
                    const val = (data.cotizacion !== null) ? data.cotizacion : 0;
                    $("#valor-soja-final").data("valor-soja", val)
                                          .text(val ? "Cargando‚Ä¶" : "No disponible");
                    calcularResumenFinal();
                },
                error: function () { 
                    $("#valor-soja-final").text("Error").data("valor-soja", 0);
                    calcularResumenFinal(); 
                }
            });
        }

        // Inicial
        generarResumen();
        obtenerValorSoja();
                // --- MODAL ESTABLECIMIENTO (bloque limpio) ---
        const $modal = $("#modal-est");
        const $modalContent = $("#modal-est-content");
        let $lineaObjetivo = null;   // l√≠nea que abri√≥ el modal

        function abrirModal(html){
        $modalContent.html(html);
        $modal.show();
        }
        function cerrarModal(){
        $modal.hide();
        $modalContent.html("");
        }

        // Abrir modal al click en "Elegir / Crear"
        $("#formset").on("click", "button[data-accion='elegir-est']", function(e){
        e.preventDefault();
        const socioId = $("#id_socio").val();
        if (!socioId) {
            alert("Primero seleccion√° un socio para poder crear el establecimiento.");
            return;
        }
        $lineaObjetivo = $(this).closest(".formset-linea");

        $.ajax({
            url: "{% url 'establecimiento_modal' %}",
            data: { socio_id: socioId },
            success: function(html){
            abrirModal(html);
            },
            error: function(xhr){
            alert("No se pudo abrir el formulario de Establecimiento.");
            console.error(xhr.responseText || xhr.statusText);
            }
        });
        });

        // Cerrar modal
        $("#modal-est").on("click", "#cancelar-modal", cerrarModal);
        $("#modal-est").on("click", function(e){
        if (e.target === e.currentTarget) cerrarModal();
        });

        // Seleccionar existente
        $("#modal-est").on("click", ".seleccionar-est", function(){
        if (!$lineaObjetivo) return;
        const $tr = $(this).closest("tr");
        const id  = $tr.data("id");
        const nom = $tr.data("nombre") || "";
        const depto = $tr.data("departamento") || "";
        const gps   = $tr.data("gps") || "";
        const zona  = $tr.data("zona") || "";

        // setear hidden + select oculto
        const $sel = $lineaObjetivo.find("select[name$='establecimiento']");
        $lineaObjetivo.find("input[name$='establecimiento']").val(id);

        // si no existe la opci√≥n, agregarla
        if ($sel.find(`option[value="${id}"]`).length === 0) {
            $sel.append($("<option>").val(id).text(nom));
        }
        $sel.val(id).trigger("change"); // üëà dispara handlers dependientes

        // mostrar nombre e info
        $lineaObjetivo.find(".est-nombre").text(nom || "‚Äî Sin seleccionar ‚Äî");
        $lineaObjetivo.find(".departamento").text(depto);
        $lineaObjetivo.find(".gps").text(gps);
        $lineaObjetivo.find(".zona").text(zona);

        // recalcular dependencias
        cargarAportePorZonaYCultivo($lineaObjetivo);
        actualizarSubsidioMaximo($lineaObjetivo);
        recalcularTodo();

        cerrarModal();
        });

        // Guardar ‚Äúnuevo‚Äù
        $("#modal-est").on("submit", "#form-nuevo-est", function(e){
            e.preventDefault();
            if (!$lineaObjetivo) return;
        
            const $form = $(this);
            const socioId = $("#id_socio").val() || "";
            const data = $form.serialize() + "&socio_id=" + encodeURIComponent(socioId);
        
            $.ajax({
            url: "{% url 'establecimiento_modal' %}",
            method: "POST",
            data: data,
            success: function(resp){
                if (resp && resp.ok){
                const id  = String(resp.id);
                const nom = resp.nombre || "";
        
                // hidden + select
                const $sel = $lineaObjetivo.find("select[name$='establecimiento']");
                $lineaObjetivo.find("input[name$='establecimiento']").val(id);
        
                // üö© clave: asegurar que exista la opci√≥n en el select
                if ($sel.find(`option[value="${id}"]`).length === 0) {
                    $sel.append($("<option>").val(id).text(nom));
                }
                $sel.val(id).trigger("change");  // üëà dispara cargarAporte/actualizarSubsidio
        
                // pintar info visible
                $lineaObjetivo.find(".est-nombre").text(nom || "‚Äî Sin seleccionar ‚Äî");
                $lineaObjetivo.find(".departamento").text(resp.departamento || '');
                $lineaObjetivo.find(".gps").text(resp.gps || '');
                $lineaObjetivo.find(".zona").text(resp.zona || '');
        
                cerrarModal();
                } else {
                alert("Respuesta inesperada del servidor.");
                }
            },
            error: function(xhr){
                if (xhr.status === 422){
                $("#modal-est-content").html(xhr.responseText);
                } else {
                alert("No se pudo guardar el Establecimiento.");
                console.error(xhr.status, xhr.responseText || xhr.statusText);
                }
            }
        });
        });        
    });
</script>
{% endblock %}








