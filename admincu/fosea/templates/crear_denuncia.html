{% extends 'raiz.html' %}
{% load static %}

{% block titulo %}Nueva Denuncia{% endblock %}
{% block header %}Nueva Denuncia{% endblock %}

{% block contenido %}
<style>
  .contenido-interno{
    background:#fff; padding:20px; border-radius:12px; 
    max-width:1500px; margin:20px auto;
    box-shadow:0 6px 22px rgba(0,0,0,.08);
  }

  .form-row{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:15px; }
  .form-row .form-group{ flex:1; min-width:220px; }
  .form-group{ margin-bottom:15px; }

  label{ display:block; font-weight:600; margin-bottom:6px; color:#333; }

  select, input[type="text"], input[type="date"], input[type="number"]{
    width:100%; padding:8px 10px; border:1px solid #dcdcdc; border-radius:8px; background:#fff;
  }

  .formset-linea{
    display:grid;
    grid-template-columns: 2fr 1.5fr 1fr 2fr 56px; 
    gap:12px;
    padding:16px;
    border:1px dashed #e6e6e6;
    border-radius:10px;
    background:#fafafa;
    align-items:start;
    margin-bottom:10px;
  }

  .formset-linea .campo{ display:flex; flex-direction:column; }

  .eliminar-wrapper{ align-self:center; justify-self:center; }

  .icon-btn{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; border:none; border-radius:10px; cursor:pointer;
    background:#ffe8e6;
    transition:transform .08s ease, background .15s ease;
  }

  .icon-btn:hover{ background:#ffd5d1; transform:translateY(-1px); }
  .icon-btn:active{ transform:translateY(0); }

  .icon-trash{ width:18px; height:18px; fill:#e74c3c; }

  input[name$="-DELETE"]{ display:none; }

  @media (max-width: 1100px){
    .formset-linea{
      grid-template-columns: 1fr 1fr;
    }
    .eliminar-wrapper{ grid-column: 2; }
  }

  .errorlist {
    color: #e74c3c;
    margin-top: 4px;
    margin-bottom: 0;
    font-size: 0.9em;
    font-weight: 500;
    list-style: none;
    padding-left: 0;
  }
</style>

<div class="contenido-interno">
  <form method="post">
    {% csrf_token %}

    <!-- ================= DATOS GENERALES ================= -->
    <div class="form-row">
      <div class="form-group">
        {{ form.fecha.label_tag }} {{ form.fecha }}
      </div>

      <div class="form-group">
        <label for="id_campaña">Campaña:</label>
        <select name="campaña" id="id_campaña" class="form-control">
          <option value="">---------</option>
          {% for c in form.fields.campaña.queryset %}
            <option value="{{ c.id }}" {% if form.initial.campaña == c.id %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        {{ form.socio.label_tag }} {{ form.socio }}
      </div>
    </div>

    <hr>

    <h3>Líneas de Denuncia</h3>

    {{ form.non_field_errors }}
    {{ formset.non_form_errors }}
    {% for f in formset %}{{ f.non_field_errors }}{% endfor %}

    <!-- ================= FORMSET ================= -->
    <div id="formset">
      {{ formset.management_form }}

      {% for f in formset %}
      <div class="formset-linea">
        {{ f.id }}

        <div class="campo">{{ f.establecimiento.label_tag }} {{ f.establecimiento }} {{ f.establecimiento.errors }}</div>
        <div class="campo">{{ f.cultivo.label_tag }} {{ f.cultivo }} {{ f.cultivo.errors }}</div>
        <div class="campo">{{ f.hectareas_afectadas.label_tag }} {{ f.hectareas_afectadas }} {{ f.hectareas_afectadas.errors }}</div>
        <div class="campo">{{ f.observacion.label_tag }} {{ f.observacion }}</div>

        {{ f.DELETE }}

        <div class="eliminar-wrapper">
          <button type="button" class="icon-btn eliminar-linea" title="Eliminar línea">
            <svg class="icon-trash" viewBox="0 0 24 24">
              <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1v12a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V7H4V5h4V4a1 1 0 0 1 1-1zm1 4H7v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V7h-3H10zm1 3h2v8h-2V10zm-4 0h2v8H7v-8zm8 0h2v8h-2v-8zM10 5v0h4V4h-4v1z"/>
            </svg>
          </button>
        </div>

      </div>
      {% endfor %}
    </div>

    <!-- ================= TEMPLATE VACÍO ================= -->
    <template id="tpl-empty">
      <div class="formset-linea">
        {{ formset.empty_form.id }}

        <div class="campo">{{ formset.empty_form.establecimiento.label_tag }} {{ formset.empty_form.establecimiento }}</div>
        <div class="campo">{{ formset.empty_form.cultivo.label_tag }} {{ formset.empty_form.cultivo }}</div>
        <div class="campo">{{ formset.empty_form.hectareas_afectadas.label_tag }} {{ formset.empty_form.hectareas_afectadas }}</div>
        <div class="campo">{{ formset.empty_form.observacion.label_tag }} {{ formset.empty_form.observacion }}</div>

        {{ formset.empty_form.DELETE }}

        <div class="eliminar-wrapper">
          <button type="button" class="icon-btn eliminar-linea" title="Eliminar línea">
            <svg class="icon-trash" viewBox="0 0 24 24">
              <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1v12a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V7H4V5h4V4a1 1 0 0 1 1-1zm1 4H7v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V7h-3H10zm1 3h2v8h-2V10zm-4 0h2v8H7v-8zm8 0h2v8h-2v-8zM10 5v0h4V4h-4v1z"/>
            </svg>
          </button>
        </div>
      </div>
    </template>

    <!-- ================= BOTÓN AGREGAR ================= -->
    <button type="button" id="agregar-linea"
      class="btn"
      style="background:#2ecc71;color:#fff;margin-bottom:10px;border:none;border-radius:10px;padding:10px 16px;">
      Agregar línea
    </button>

    <!-- ================= BOTONES ================= -->
    <div class="botones" style="margin-top:22px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;">
      <a href="{% url 'registro_denuncias' %}"
         class="btn btn-cancelar"
         style="background:#95a5a6;color:#fff;border:none;border-radius:10px;padding:10px 16px;">
         Cancelar
      </a>

      <button type="submit"
        class="btn btn-guardar"
        style="background:#3498db;color:#fff;border:none;border-radius:10px;padding:10px 16px;">
        Guardar
      </button>
    </div>

  </form>
</div>

<!-- ======================= JS ======================= -->
<script>
(function(){

  const $formset = document.getElementById('formset');
  const $tpl = document.getElementById('tpl-empty');
  const $btnAdd = document.getElementById('agregar-linea');

  function q(s,c=document){ return c.querySelector(s); }
  function qa(s,c=document){ return Array.from(c.querySelectorAll(s)); }

  function totalFormsEl(){ return q('#id_form-TOTAL_FORMS'); }
  function getTotal(){ return parseInt(totalFormsEl().value||'0',10); }
  function setTotal(v){ totalFormsEl().value=String(v); }

  /* ===================== AGREGAR LÍNEA ===================== */
  function addLinea(){
    const idx = getTotal();
    const html = $tpl.innerHTML.replace(/__prefix__/g, idx);
    const wrap = document.createElement('div');
    wrap.innerHTML = html.trim();
    const node = wrap.firstElementChild;
    $formset.appendChild(node);
    setTotal(idx+1);

    const socioId = q('#id_socio')?.value || '';
    const campañaId = q('#id_campaña')?.value || '';
    filtrarEstablecimientosNodo(node, socioId, campañaId);
  }

  $btnAdd?.addEventListener('click', addLinea);

  /* ===================== ELIMINAR LÍNEA ===================== */
  $formset.addEventListener('click', e => {
    const btn = e.target.closest('.eliminar-linea');
    if (!btn) return;

    const row = btn.closest('.formset-linea');
    const del = row.querySelector("input[name$='-DELETE']");
    if (del) {
      del.checked = true;
      row.style.display = 'none';
    } else {
      row.remove();
    }
  });

  /* ================= FILTRADO DE ESTABLECIMIENTOS ================= */
  function filtrarEstablecimientosGlobal(socioId, campañaId){
    qa("select[name$='establecimiento']", $formset)
      .forEach(sel => filtrarEstablecimientosNodo(sel.closest('.formset-linea'), socioId, campañaId));
  }

  function filtrarEstablecimientosNodo(node, socioId, campañaId){
    const sel = node.querySelector("select[name$='establecimiento']");
    if (!sel) return;

    if (!socioId){
      sel.innerHTML = '<option value="">Seleccioná un socio primero</option>';
      sel.disabled = true;
      return;
    }

    const url = "{% url 'establecimientos_filtrados' %}?socio_id="
                + encodeURIComponent(socioId)
                + (campañaId ? "&campaña_id="+encodeURIComponent(campañaId) : "");

    fetch(url)
      .then(r => r.json())
      .then(data => {
        const current = sel.value;
        sel.innerHTML = '<option value="">---------</option>';
        (data.establecimientos || []).forEach(est => {
          const opt = document.createElement('option');
          opt.value = est.id;
          opt.textContent = est.nombre;
          sel.appendChild(opt);
        });
        if (current && sel.querySelector(`option[value="${current}"]`))
          sel.value = current;
        sel.disabled = false;
      });
  }

  const socioSel = document.getElementById('id_socio');
  const campañaSel = document.getElementById('id_campaña');

  function initFiltroSocioCampaña(){
    const actualizar = () =>
      filtrarEstablecimientosGlobal(socioSel?.value, campañaSel?.value);

    socioSel?.addEventListener('change', actualizar);
    campañaSel?.addEventListener('change', actualizar);
    actualizar();
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (getTotal() === 0) addLinea();
    initFiltroSocioCampaña();
  });

})();
</script>

{% endblock %}
